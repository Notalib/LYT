<!DOCTYPE html>  <html> <head>   <title>rpc.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="cache.html">                 cache.coffee               </a>                                           <a class="source" href="config.html">                 config.coffee               </a>                                           <a class="source" href="daisy.html">                 daisy.coffee               </a>                                           <a class="source" href="nccfile.html">                 nccfile.coffee               </a>                                           <a class="source" href="protocol.html">                 protocol.coffee               </a>                                           <a class="source" href="rpc.html">                 rpc.coffee               </a>                                           <a class="source" href="service.html">                 service.coffee               </a>                                           <a class="source" href="utils.html">                 utils.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               rpc.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This function performs a remote procedure call from the <code>protocol</code> module</p>

<p>E.g.</p>

<pre><code>rpc "logOn", "someUser", "supeSekretPassword"
</code></pre>

<p>See protocol.coffee for more</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Define <code>rpc</code> inside a closure</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@rpc = </span><span class="nx">do</span> <span class="o">-&gt;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The template for SOAP request content</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">soapTemplate = </span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s1">    &lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:ns1=&quot;http://www.daisy.org/ns/daisy-online/&quot;&gt;</span>
<span class="s1">    &lt;SOAP-ENV:Body&gt;#{body}&lt;/SOAP-ENV:Body&gt;</span>
<span class="s1">    &lt;/SOAP-ENV:Envelope&gt;&#39;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The actual <code>rpc</code> function</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nf">(action, args...) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Throw a fit if the argument isn't a string</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="k">typeof</span> <span class="nx">action</span> <span class="o">is</span> <span class="s2">&quot;string&quot;</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span>
    </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Also complain if the <code>protocol</code> module doens't contain the RPC</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">protocol</span><span class="p">[</span><span class="nx">action</span><span class="p">]</span><span class="o">?</span>
      <span class="k">throw</span> <span class="s2">&quot;RPC: Action \&quot;#{action}\&quot; not found&quot;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Get the RPC object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">handlers = </span><span class="nx">protocol</span><span class="p">[</span><span class="nx">action</span><span class="p">]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Clone the default options</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">options = </span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">config</span><span class="p">.</span><span class="nx">rpc</span><span class="p">.</span><span class="nx">options</span>
    </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Get the request data from the RPC's <code>request</code> function, if present, passing along any arguments</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">soap = </span><span class="nx">handlers</span><span class="p">.</span><span class="nx">request</span><span class="o">?</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span> <span class="o">or</span> <span class="kc">null</span>
    <span class="nv">soap = </span><span class="kc">null</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">soap</span> <span class="o">isnt</span> <span class="s2">&quot;object&quot;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Convert the data obj to XML and insert it into the SOAP template</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">xml = </span><span class="p">{}</span>
    <span class="nx">xml</span><span class="p">[</span><span class="nx">action</span><span class="p">]</span> <span class="o">=</span> <span class="nx">soap</span>
    <span class="nv">xml = </span><span class="nx">rpc</span><span class="p">.</span><span class="nx">toXML</span> <span class="nx">xml</span>
    <span class="nv">xml = </span><span class="k">if</span> <span class="nx">xml</span> <span class="o">isnt</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="s2">&quot;&lt;ns1:#{action}&gt;#{xml}&lt;/ns1:#{action}&gt;&quot;</span> <span class="k">else</span> <span class="s2">&quot;&lt;ns1:#{action} /&gt;&quot;</span>
    <span class="nv">options.data = </span><span class="nx">soapTemplate</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/#\{body\}/</span><span class="p">,</span> <span class="nx">xml</span>
    </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Log the call</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">log</span><span class="p">.</span><span class="nx">group</span> <span class="s2">&quot;RPC: Calling \&quot;#{action}\&quot;&quot;</span><span class="p">,</span> <span class="nx">soap</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">data</span>
    </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Set up the success handler</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">options.success  = </span><span class="nf">(data, status, xhr) -&gt;</span>
      <span class="nv">$xml = </span><span class="nx">jQuery</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>FIXME: Generalize the fault-handling to handle other faults too. Also, wouldn't it be better to check faultcodes rather than faultstrings?</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">$xml</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;faultstring&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">match</span> <span class="nx">errorRegExp</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">group</span> <span class="s2">&quot;RPC: Error: Invalid/uninitialized session&quot;</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">message</span> <span class="nx">data</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">closeGroup</span><span class="p">()</span>
        <span class="nx">eventSystemNotLoggedIn</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">group</span> <span class="s2">&quot;RPC: Response for action \&quot;#{action}\&quot;&quot;</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">message</span> <span class="nx">data</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">closeGroup</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Call the RPC's <code>receive</code> function, if it exists</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">receive</span><span class="o">?</span> <span class="k">then</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">receive</span> <span class="nx">$xml</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">xhr</span>
    </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Attach the RPC's <code>complete</code> handler (if any)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">options.complete = </span><span class="nx">handlers</span><span class="p">.</span><span class="nx">complete</span> <span class="k">if</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">complete</span><span class="o">?</span>
    </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Attach the RPC's <code>error</code> handler (or use the default)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">options.error    = </span><span class="nx">handlers</span><span class="p">.</span><span class="nx">error</span> <span class="o">or</span> <span class="nx">rpc</span><span class="p">.</span><span class="nx">error</span>
    </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Perform the request</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>This utility function converts the arguments given to well-formed XML</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@rpc.toXML = </span><span class="nf">(hash) -&gt;</span>
  <span class="k">return</span> <span class="s2">&quot;&quot;</span> <span class="nx">unless</span> <span class="nx">hash</span><span class="o">?</span>
  
  <span class="nv">xml = </span><span class="s2">&quot;&quot;</span>
  <span class="nv">type = </span><span class="k">typeof</span> <span class="nx">hash</span>
  </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>If the argument is a string, number or boolean, then coerce it to a string and return it</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;string&quot;</span> <span class="o">or</span> <span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;number&quot;</span> <span class="o">or</span> <span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;boolean&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Escape XML special chars</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">hash = </span><span class="nb">String</span><span class="p">(</span><span class="nx">hash</span><span class="p">).</span><span class="nx">replace</span> <span class="sr">/&amp;(?![a-z0-9]+;)/gi</span><span class="p">,</span> <span class="s2">&quot;&amp;amp;&quot;</span>
    <span class="nv">hash = </span><span class="nx">hash</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/&lt;/g</span><span class="p">,</span> <span class="s2">&quot;&amp;lt;&quot;</span>
    <span class="nv">hash = </span><span class="nx">hash</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/&gt;/g</span><span class="p">,</span> <span class="s2">&quot;&amp;gt;&quot;</span>
    <span class="k">return</span> <span class="nx">hash</span>
  </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>If the argument is an object</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;object&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Loop through the object, recursively converting members to XML</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">hash</span>
      <span class="nv">key = </span><span class="nx">rpc</span><span class="p">.</span><span class="nx">toXML</span> <span class="nx">key</span>
      <span class="k">if</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Array</span>
        <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;ns1:#{key}&gt;#{rpc.toXML item}&lt;/ns1:#{key}&gt;&quot;</span> <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">value</span>
      <span class="k">else</span>
        <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;ns1:#{key}&gt;#{rpc.toXML value}&lt;/ns1:#{key}&gt;&quot;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Return the XML</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">xml</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>The default ajax error handler</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@rpc.error = </span><span class="nx">do</span> <span class="o">-&gt;</span>
  <span class="nv">errorRegExp = </span><span class="sr">/session (is (invalid|uninitialized)|has not been initialized)/i</span>
  
  <span class="nf">(xhr, error, exception) -&gt;</span>
    <span class="nv">title = </span><span class="s2">&quot;ERROR: RPC: &quot;</span>
    <span class="k">if</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">&gt;</span> <span class="mi">399</span>
      <span class="nx">title</span> <span class="o">+=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">exception</span> <span class="o">is</span> <span class="s2">&quot;timeout&quot;</span>
      <span class="nx">alert</span> <span class="s2">&quot;Ups - vi misted forbindelsen. MÃ¥ske har du ingen forbindelse til Internettet?&quot;</span>
      <span class="nx">title</span> <span class="o">+=</span> <span class="s2">&quot;Timed out&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">match</span> <span class="nx">errorRegExp</span>
      <span class="nx">eventSystemNotLoggedIn</span><span class="p">()</span>  <span class="c1"># FIXME: Not a great function name</span>
      <span class="nx">title</span> <span class="o">+=</span> <span class="s2">&quot;Invalid/uninitialized session&quot;</span>
    <span class="k">else</span>
      <span class="nx">title</span> <span class="o">+=</span> <span class="s2">&quot;General error&quot;</span>
    
    <span class="nx">log</span><span class="p">.</span><span class="nx">errorGroup</span> <span class="nx">title</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">error</span> <span class="nx">xhr</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="nx">error</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="nx">exception</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;Response: &quot;</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">closeGroup</span><span class="p">()</span>
  
  
  

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 