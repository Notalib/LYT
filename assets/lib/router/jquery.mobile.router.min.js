!function(e,t){"function"==typeof define&&define.amd?define(["jquery"],t):t(jQuery)}(this,function(e){return e(document).on("mobileinit",function(){var t=e.extend({fixFirstPageDataUrl:!1,firstPageDataUrl:"index.html",ajaxApp:!1,firstMatchOnly:!1,defaultArgsRe:!1},e.mobile.jqmRouter||{}),a=null,n=null,o=!1;e(document).on("pagebeforechange",function(t,r){var s="string"==typeof r.toPage?r.toPage:r.toPage.jqmData("url")||"";if(!r.options.hasOwnProperty("_jqmrouter_handled")){r.options._jqmrouter_handled=!0,r.options.data&&"get"==(r.options.type+"").toLowerCase()&&(s+="?"+r.options.data);var i=e.mobile.path.parseUrl(s);a=n,n=i,-1!=i.hash.indexOf("?")&&(r.options.dataUrl=i.hash.replace(/^#/,""));var l=/^#|\?.*$/g;a&&i.hash!=a.hash&&i.hash.replace(l,"")==a.hash.replace(l,"")&&(r.options.allowSamePageTransition=!0&&!o),o=!1,-1!=window.location.hash.indexOf("&ui-state=dialog")&&(o=!0)}}),t.fixFirstPageDataUrl&&e(document).ready(function(){if(window.location.pathname.match("/$")){var a=e(":jqmData(role='page')").first(),n=a.jqmData("url"),o=window.location.pathname+t.firstPageDataUrl+window.location.search+window.location.hash;n!=o&&a.attr("data-url",o).jqmData("url",o)}}),e.mobile.Router=function(a,n,o){if(this.routes={pagebeforecreate:null,pagecreate:null,pagebeforeshow:null,pageshow:null,pagebeforehide:null,pagehide:null,pageinit:null,pageremove:null,pagebeforechange:null,pagebeforeload:null,pageload:null,popupbeforeposition:null,popupafteropen:null,popupafterclose:null},this.evtLookup={bC:"pagebeforechange",bl:"pagebeforeload",l:"pageload",bc:"pagebeforecreate",c:"pagecreate",bs:"pagebeforeshow",s:"pageshow",bh:"pagebeforehide",h:"pagehide",i:"pageinit",rm:"pageremove",pbp:"popupbeforeposition",pao:"popupafteropen",pac:"popupafterclose"},this.routesRex={},this.conf=e.extend({},t,o||{}),this.defaultHandlerEvents={},this.conf.defaultHandlerEvents)for(var r=this.conf.defaultHandlerEvents.split(","),s=0;s<r.length;s++)this.defaultHandlerEvents[this.evtLookup[r[s]]]=r[s];this.add(a,n)},e.extend(e.mobile.Router.prototype,{documentEvts:{pagebeforechange:1,pagebeforeload:1,pageload:1},debug:function(e){var t=this.conf;t.debugHandler?t.debugHandler.apply(this,arguments):t.debugHandler!==!1&&"undefined"!=typeof console&&console.log&&(console.log.apply(console,arguments),e.stack&&console.log(e.stack))},add:function(t,a,n){if(t){var o=this,r=[],s=[];if(t instanceof Array?e.each(t,e.proxy(function(e,t){this.add(t,a,!0)},this)):e.each(t,function(e,t){if("string"==typeof t||"function"==typeof t)null===o.routes.pagebeforeshow&&(o.routes.pagebeforeshow={}),o.conf.defaultArgsRe&&(e+="(?:[?](.*))?$"),o.routes.pagebeforeshow[e]=t,o.routesRex.hasOwnProperty(e)||(o.routesRex[e]=new RegExp(e));else{var a,n,r=t.events.split(",");for(t.argsre!==!1&&(t.argsre||o.conf.defaultArgsRe)&&(e+="(?:[?](.*))?$"),a=0;a<r.length;a++)n=o.evtLookup[r[a]],o.routes.hasOwnProperty(n)?(null===o.routes[n]&&(o.routes[n]={}),o.routes[n][e]=t.handler,o.routesRex.hasOwnProperty(e)||(o.routesRex[e]=new RegExp(e))):o.debug("can't set unsupported route "+r[a])}}),n!==!0){this.userHandlers?e.extend(this.userHandlers,a||{}):this.userHandlers=a||{},e.each(o.routes,function(e,t){null!==t&&(o.documentEvts[e]?s.push(e):r.push(e))}),this._detachEvents();var i=function(e,t){o._processRoutes(e,t,this)};r.length>0&&(this._eventData={events:r.join(" "),selectors:":jqmData(role='page'),:jqmData(role='dialog')",handler:i},e(document).on(this._eventData.events,this._eventData.selectors,this._eventData.handler)),s.length>0&&(this._docEventData={events:s.join(" "),handler:i},e(document).on(this._docEventData.events,this._docEventData.handler))}}},_processRoutes:function(t,o,r){var s,i,l,u=this,p=0;if("pagebeforechange"==t.type){if("string"==typeof o.toPage||o.options._jqmrouter_bC)return;r=o.toPage}s=t.type in{pagebeforehide:!0,pagehide:!0,pageremove:!0}?a:n;do{if(s){if(!this.documentEvts[t.type]&&r&&!e(r).jqmData("url"))return}else r&&(l=e(r),s=l.jqmData("url"),s&&(l.attr("id")==s&&(s="#"+s),s=e.mobile.path.parseUrl(s)));if(!s)return;i=this.conf.ajaxApp?s.pathname+s.search+s.hash:s.hash,0==i.length&&(s=""),p++}while(0==i.length&&1>=p);var h=!1,d="pagebeforechange"==t.type?e.Deferred():null;if(e.each(this.routes[t.type],function(e,a){var n,s;if((n=i.match(u.routesRex[e]))&&("function"==typeof a?s=a:"function"==typeof u.userHandlers[a]&&(s=u.userHandlers[a]),s))try{d&&o&&(o.bCDeferred=d),s.apply(u.userHandlers,[t.type,n,o,r,t]),h=!0}catch(l){u.debug(l)}return h&&u.conf.firstMatchOnly?!1:void 0}),!h&&this.conf.defaultHandler&&this.defaultHandlerEvents[t.type]){var f;"function"==typeof this.conf.defaultHandler?f=this.conf.defaultHandler:"function"==typeof this.userHandlers[this.conf.defaultHandler]&&(f=this.userHandlers[this.conf.defaultHandler]);try{f.apply(this.userHandlers,[t.type,o,r,t])}catch(c){this.debug(c)}}"pagebeforechange"==t.type&&h&&(t.preventDefault(),d.done(function(){e.mobile.changePage(o.toPage,{_jqmrouter_handled:!0,_jqmrouter_bC:!0,dataUrl:o.options.dataUrl})}))},_detachEvents:function(){this._eventData&&e(document).off(this._eventData.events,this._eventData.selectors,this._eventData.handler),this._docEventData&&e(document).off(this._docEventData.events,this._docEventData.handler)},destroy:function(){this._detachEvents(),this.routes=this.routesRex=null},getParams:function(t){if(!t)return null;var a,n={},o=t.slice(t.indexOf("?")+1).split("&");return e.each(o,function(e,t){a=t.split("="),a[0]=decodeURIComponent(a[0]),n[a[0]]?(n[a[0]]instanceof Array||(n[a[0]]=[n[a[0]]]),n[a[0]].push(decodeURIComponent(a[1]))):n[a[0]]=decodeURIComponent(a[1])}),e.isEmptyObject(n)?null:n}})}),{}});
